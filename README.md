# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

Товар (интерфейс используется и для попапа с товаром, по скольку включает в себя те же данные)

```
interface IProduct {
  id: string;
  description: string;
  image: string;
  title: string;
  category: string;
  price: number;
  index?: number;
}
```

Покупатель

```
interface IUser {
  payment: 'card' | 'cash' | '';
  address: string;
  email: string;
  phone: string;
  events?: IEvents;
  total?: number | null;
  items?: string[]
}
```

Корзина

```
type IBasket = Pick<IUser, 'items' | 'total' | 'events'>;
```

Попап формы с выборомом способа оплаты и адресом при покупке товара

```
type IFormAddress = Pick<IUser, 'payment' | 'address'>;
```

Попап формы с контактами (почта и телефон) при покупке товара

```
type IFormContacts = Pick<IUser, 'email' | 'phone'>;
```

Итоговый попап с подтверждением покупки товара(ов)

```
type IFormSuccess = Pick<IBasket, 'total'>;
```

Интерфейс связанный с валидацией и ошибками

```
interface IAppState {
	validation?: boolean;
	errors?: string[];
}
```

Интерфейс для отображения каталога

```
interface IPage {
	counter: number;
	catalog: HTMLElement[];
	locked: boolean;
}
```

Интерфейс ответа сервера при успешном заказе

```
export interface IOrderResponse {
  id: string;
  total: number;
}
```

Интерфейс изменения каталога

```
interface ICatalogChanged {  // изменение каталога
  catalog: IProduct[];
}
```

Интерфейс Api

```
interface IAppApi { // Интерфейс методов для работы с апи
  getCatalog(): Promise<IProduct[]>;  // гет запрос на каталог
  getProduct(id: string): Promise<IProduct>;  // гет запрос на товар
  createOrder(order: IUser): Promise<IOrderResponse>;  // это пост запрос на создание заказа(!)
}
```

Интерфейс для ошибок в форме

```
type FormErrors = Partial<Record<keyof IUser, string>>;  
```

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP: 
- слой представления, отвечает за отображение данных на странице, 
- слой данных, отвечает за хранение и изменение данных
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие   


### Слой данных


#### Класс Model
Абстрактный класс Model является родительским классом для класса AppData.
В полях класса хранятся следующие данные:
- events: IEvents - обработчик событий
Методы:
- emitChanges(event: string, payload?: object) - сообщает об изменении


#### Класс AppState
Данный класс работает со всеми основными данными, корзиной, формой, валидацией. Наследует абстрактрый класс Model.
В полях класса хранятся следующие методы:
- catalog: IProduct[] - массив товаров;
- user: IUser - информация о пользователе;
- formErrors: FormErrors = {} - ошибки валидации;
Методы:
- setCatalog(items: IProduct[]) - изменение каталога товаров;
- toggleOrderItem(id: string, isIncluded: boolean) - изменение состояния корзины;
- clearBasket() - очистка корзины;
- getTotal():number - получение суммы товаров;
- getCards(): IProduct[] - получение массива товаров в корзине;
- isFilledFieldsAddress(): boolean - проверка заполнения формы с адресом и способом оплаты;
- isFilledFieldsContacts(): boolean  - проверка заполнения формы с контактами;
- clearFields() - очистка полей;
- setField<K extends keyof IUser>(field: K, value: IUser[K]) - получение значения поля;
- setPaymentMethod(method: 'card' | 'cash' | '') - получение способа оплаты;
- validateAddress(): boolean - проверка валидации формы с адресом и способом оплаты;
- validateContacts(): boolean - проверка валидации формы с контактами;


### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.


#### Класс Page
Класс Page отвечает за отображение всей главной страницы. В его задачи входит управление контейнером для карточек, кнопкой корзины и счетчиком товаров.
-	_catalog: HTMLElement — контейнер для карточек товаров.
- _basketCounter: HTMLElement — контейнер счётчика товаров в корзине.
- _basketButton: HTMLButtonElement — кнопка для открытия корзины.
- _wrapper: HTMLElement - обертка.
Методы:
- set counter(value: number) - утсновливает счётчик товаров
- set catalog(items: HTMLElement[]) - устанавливает вывод всех товаров на страницу
- set locked(value: boolean) - блокировка прокрутки


#### Класс ProductView
Класс ProductView отвечает за отображение одной карточки с товаром. Наследуется от Component. Поддерживает набор данных IProduct.
Поля:
- id - id карточки
- description - описание карточки
- images - картинку карточки
- title - название карточки
- category - группу товаров карточки
- price? - её цену, либо null.
- isInBasket: boolean - изменение состояния товара(в корзине)
Методы:
- set id(value: string) - установка карточки
- get id(): string - получение карточки
- set title(value: string) - установка заголовка карточки
- set price(value: number | null) - установка цены либо null, если "бесценно"
- set buttonText(value: string) - усиавновка текста кнопки
- get isInBasket(): boolean - получение корзины
- set isInBasket(value: boolean) - обновление текста кнопки
- toggleButton(state: boolean) - включение/выключение кнопки
- set description(value: string | string[]) - установка описания товара
- set category(value: string) - установка категории товара
- set image(value: string) - установка изображения


#### Класс BasketView
Класс BasketView отвечает за отображение корзины с товарами. Аналогично классу ProductView будет насловаться от Component. Поддерживает набор данных IBasket. В конструкторе будет необходим EventEmmiter для взаимодействия с кнопкой
_products - массив товаров
_total - итоговая сумма
_buttonSubmit - кнопка сабмита

Методы:
Сеттеры будут изменять следующие значения:
set items(items: HTMLElement[]) - обновляет содержимое корзины;
get items(): HTMLElement[] - получает содержимое корзины;
set selected(items: string[]) - управление состоянием кнопки;
set total(total: number) - обновление общей стоимости всех товаров в корзине.


#### Класс BasketItem
Класс необходим для отображения товара в модальном окне корзины
Поля:
- _index: HTMLElement - порядковый номер товара в корзине;
- _buttonDelete: HTMLButtonElement - кнопка удаления товара из корзины;
Методы:
set index(value: number) - отображение порядкого номера в корзине

#### Класс Modal
Общий класс для модальных окон(!). Реализует модальное окно. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.
Поля класса
- buttonClose - кнопка закрытия попапа по крестику
- _content - контейнер для контента
Методы:
- open(открытие попапа) и close(закрытие попапа);
- addEventListeners(): void - устанавливает слушатель событий на закрытие попапа по кнопке крестик, клику на оверлей, и клавише "Esc". 
- set content - устанавливает содержимое модального окна

#### Класс Form
Общий класс для форм. Реализует попап с формой. 
Поля класса:
- button: <HTMLButtonElement> - кнопка сабмита в форме;
- errors: <HTMLElement> - текст ошибки в случае невалидности;
Методы:
- onInputChange(field: keyof T, value: string) - отображние изменения инпутов;
- set valid(value: boolean) - проверка валидности, отвечает за состояние кнопки;
- set errors(value: string) - устанавливает текст ошибки;
- render(state: Partial<T> & IAppState) - рендер элемента;
  

#### Класс Order
Класс для формы с полями способа оплаты и адреса. Наследует класс формы
Поля класса:
- buttonCash - кнопка выбора оплаты наличнымиж
- buttonCard -  кнопка выбора оплаты картойж
Методы:
- paymentChange(value: string) - обработка изменения способа оплаты;
- set address(value: string) - установка значения инпута с адресом;
- set payment(value: string) - установка способа оплаты а так же кнопки выбранного способа;

#### Класс FormContacts
Класс для формы с полями почты и телефона. Наследует класс формы, с одной поправкой на наличие сеттеров для почты покупателя и телефона.
Методы:
- set phone(value: string) - установка значения инпута с телефоном;
- set email(value: string) - установка значения инпута с почтой;

#### Класс FormSuccess
Класс для итоговой формы с завершение заказа. наследует класс формы. Присутствует только один сеттер для установки итоговой суммы заказа(total)
Методы:
- set total(total: number) - установка итоговой суммы заказа;

### Слой коммуникации

#### Класс AppApi
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.
Методы:
- getCatalog() - получение каталога товаров;
- getProduct(id: string) - получение одного товара;
- createOrder(order: IUser) - создание заказа;

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*\
События с картами:
- item:select - выбор карточки товара при нажатии на него
- items:changed - изменение массива с товарами

События с корзиной:
- basket:open - открытие корзины
- basket:close - закрытие корзины
- basket:changed - измнение количества товаров в корзине

События с формой:
- form:open - отрытие формы
- form:close - закрытие формы
- order:open - инвент открытия формы заказа с адресом и типом оплаты
- order.payment:change - изменение формы оплаты товара
- order.address:change - изменение адреса доставки
- form:errors - изменение состояния формы валидации
- contacts:open - ивент открытия формы заказа с контактами
- contacts.email:change - изменение почты в форме
- contacts.phone:change - изменение телефона в форме
- order:submit - кнопка сабмита для перехода к форме контактов
- contacts:submit - кнопка сабмита для перехода к форме подтверждения заказа

События с остальными модальными окнами:
- modal:open - открытие модального окна
- modal:close - закрытие модального окна